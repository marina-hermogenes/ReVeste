<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" type="text/css" href="home.css" media="screen" />
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <style>
        /*CSS para formatar os cards de roupas */
        #lista-roupas {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding: 20px;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            background-color: #f9f9f9;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            min-height: 300px;
        }

        .card img {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .card h3 {
            font-size: 18px;
            font-family: 'Source Sans Pro',sans-serif;
            color: #333;
            margin-bottom: 8px;
        }

        .card p {
            font-size: 14px;
            font-family: 'Source Sans Pro',sans-serif;
            color: #555;
            margin: 4px 0;
        }

        .adicionar-carrinho {
            background-color: #4d00ff; /* Cor roxa */
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-family: 'Source Sans Pro',sans-serif;
            border-radius: 15px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .adicionar-carrinho:hover {
            background-color: #6a1b9a; /* Cor roxa mais clara para o hover */
        }

    </style>
</head>
<body>
    <header>
        <div class="inner_header">
            <img src="imagens/logo.png" id="logo">
            <form id="pesquisa">
                <div class="barra">
                    <input type="text" placeholder="O que você está procurando?" />
                    <img src="imagens/lupa.png" class="submit-icon" />
                </div>
            </form>
            <a href="" id="carrinho">
                <img src="imagens/carrinho-de-compras.png">
            </a>
            <a href="" id="perfil">
                <img src="imagens/perfil.png">
                <h2>Perfil</h2>
            </a>
            <div class="menu">
                <img src="imagens/menu.png" id="menu-icon">
                <div class="dropdown-menu" id="menu-opcoes">
                    
                </div>
            </div>
        </div>
    </header>

    <div class="barra-horizontal">
        <div class="inner-barra-horizontal">
            <a href="javascript:void(0);" class="categoria-item" onclick="carregarRoupas()">TODAS AS PEÇAS</a>
    
            <a href="javascript:void(0);" class="categoria-item" onclick="carregarRoupasPorTipo('Calça')">CALÇAS</a>

            <a href="javascript:void(0);" class="categoria-item" onclick="carregarRoupasPorTipo('Camisas')">CAMISAS</a>

            <a href="javascript:void(0);" class="categoria-item" onclick="carregarRoupasPorTipo('Calçados')">CALÇADOS</a>

            <a href="javascript:void(0);" class="categoria-item" onclick="carregarRoupasPorTipo('Bermudas')">BERMUDAS</a>

            <a href="javascript:void(0);" class="categoria-item" onclick="carregarRoupasPorTipo('Vestidos')">VESTIDOS</a>

            <a href="javascript:void(0);" class="categoria-item" onclick="carregarRoupasPorTipo('Shorts')">SHORTS</a>

            <a href="javascript:void(0);" class="categoria-item" onclick="carregarRoupasPorTipo('Agasalhos')">AGASALHOS</a>
        </div>
    </div>

    <div class="imagem-inicial">
        <img src="imagens/imagem-home.png">
        <h1>Achados únicos, feitos para <span>você</span></h1>
    </div>

    <div id="lista-roupas" class="container"></div>

    <div class="barra-inferior">
        <div class="inner-barra-inferior">
            <img src="Imagens/logo-inferior.png">
            <div class="texto">
                <h2>Informações de contato</h2>
                <div class="conjunto-texto">
                    <p>E-mail: reveste@exemplo.com</p>
                </div>
                <div class="conjunto-texto">
                    <p>Telefone/Whatsapp: (XX) XXXX-XXXX</p>
                </div>
                <div class="conjunto-texto">
                    <p>Endereço: Rua das Flores, 123</p>
                    <p>Cidade/Estado</p>
                </div>
            </div>
            <div class="texto">
                <h2>Créditos</h2>
                <div class="conjunto-texto">
                    <p>Desenvolvido por: Lívia Della Garza</p>
                    <p>Marina Hermógenes e Miguel</p>
                    <p>Chagas.</p>
                </div>
                <div class="conjunto-texto">
                    <p>Trabalho acadêmico - Engenharia de</p>
                    <p>Software (UFLA).</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:3000/roupa";

        // Função para carregar roupas de um tipo específico
        async function carregarRoupasPorTipo(tipo) {
            try {
                let url;
                if (tipo === 'Calça') {
                    url = 'http://localhost:3000/roupa/calcas';  // Rota específica para Calças
                }
                else if (tipo === 'Camisas') {
                    url = 'http://localhost:3000/roupa/camisas';  // Rota específica para Camisas
                }
                else if (tipo === 'Calçados') {
                    url = 'http://localhost:3000/roupa/calcados';  // Rota específica para Calçados
                }
                else if (tipo === 'Bermudas') {
                    url = 'http://localhost:3000/roupa/bermudas';  // Rota específica para Bermudas
                }
                else if (tipo === 'Vestidos') {
                    url = 'http://localhost:3000/roupa/vestidos';  // Rota específica para Vestidos
                }
                else if (tipo === 'Shorts') {
                    url = 'http://localhost:3000/roupa/shorts';  // Rota específica para Shorts
                }
                else if (tipo === 'Agasalhos') {
                    url = 'http://localhost:3000/roupa/agasalhos';  // Rota específica para Agasalhos
                }
                else {
                    url = 'http://localhost:3000/roupa';  // Rota para todas as roupas
                }



                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });

                if (!response.ok) {
                    throw new Error('Erro ao buscar roupas de tipo específico');
                }

                const roupas = await response.json();
                exibirRoupas(roupas);  // Atualizando a exibição na tela
            } catch (error) {
                console.error("Erro ao carregar roupas:", error);
            }
        }


        async function carregarRoupas() {
            try {
                const response = await fetch(API_URL, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (!response.ok) {
                    throw new Error('Erro ao buscar as roupas');
                }
                const roupas = await response.json();
                exibirRoupas(roupas);
            } catch (error) {
                console.error("Erro ao carregar roupas:", error);
            }
        }

        async function exibirRoupas(roupas) {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
            }
            const tokenPayload = parseJWT(token);
            const codigo = tokenPayload?.userId;
            const temEndereco = await verificarEnderecos(codigo);

            const container = document.getElementById("lista-roupas");
            const roupasDisponiveis = roupas.filter(roupa => roupa.disponivel);
            container.innerHTML = roupasDisponiveis.map(roupa => `
                <div class="card">
                    <img src="${roupa.foto || 'imagens/default-placeholder.png'}" alt="Foto da ${roupa.nome}" />
                    <h3>${roupa.nome}</h3>
                    <p><strong>Preço:</strong> R$ ${Number(roupa.preco).toFixed(2)}</p>
                    <p><strong>Descrição:</strong> ${roupa.descricao}</p>
                    <p><strong>Tamanho:</strong> ${roupa.tamanho}</p>
                    <p><strong>Tipo:</strong> ${roupa.tipo}</p>
                    <!-- Adicionando o botão -->
                    ${temEndereco ? '<button class="adicionar-carrinho">Adicionar ao Carrinho</button>' : ''}
                </div>
            `).join("");
        }

        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'login.html';
        } else {
            carregarRoupas();
        }

        const menu = document.querySelector('.menu');
        const menuIcon = document.querySelector('#menu-icon');
        menuIcon.addEventListener('click', () => {
            const dropdownMenu = menu.querySelector('.dropdown-menu');
            dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', (event) => {
            const dropdownMenu = menu.querySelector('.dropdown-menu');
            if (!menu.contains(event.target)) {
                dropdownMenu.style.display = 'none';
            }
        });

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }

        async function verificarChavePix(codigo) {
            try {
                const response = await fetch(`http://localhost:3000/usuario/${codigo}`);
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                const data = await response.json();
                return data[0].chavepix != null && data[0].chavepix !== "";
            } catch (error) {
                console.error("Erro ao verificar chave Pix:", error);
                return false; 
            }
        }

        async function verificarEnderecos(codigo) {
            try {
                const response = await fetch(`http://localhost:3000/endereco/${codigo}`);
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                const data = await response.json();
                return data.length != 0;
            } catch (error) {
                console.error("Erro ao verificar endereços:", error);
                return false; 
            }
        }

        async function configurarMenu() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
            }

            const tokenPayload = parseJWT(token);
            const codigo = tokenPayload?.userId;

            if (!codigo) {
                alert('Não foi possível identificar o usuário autenticado.');
                return;
            }

            const temChavePix = await verificarChavePix(codigo);
            const temEndereco = await verificarEnderecos(codigo);

            const dropdownMenu = document.querySelector('.dropdown-menu');

            if (temChavePix) {
                dropdownMenu.innerHTML += `
                    <a href="http://localhost:3000/cadastrarRoupa.html">Cadastrar roupa</a>
                    <a href="http://localhost:3000/getRoupasCadastradas.html">Consultar roupas cadastradas</a>
                    <a href="http://localhost:3000/getRoupasVendidas.html">Consultar roupas vendidas</a>
                `;
            } 

            if (temEndereco) {
                dropdownMenu.innerHTML += `
                    <a href="http://localhost:3000/getVenda.html">Consultar compras</a>
                `;
            } 

            dropdownMenu.innerHTML += `
                <a href="javascript:void(0);" onclick="logout()">Sair</a>
            `
        }
    

    function parseJWT(token) {
        if (!token) return null;

        const base64Url = token.split('.')[1];
        if (!base64Url) return null;

        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(
            atob(base64)
                .split('')
                .map((c) => `%${`00${c.charCodeAt(0).toString(16)}`.slice(-2)}`)
                .join('')
        );

        return JSON.parse(jsonPayload); 
    }

    document.addEventListener('DOMContentLoaded', configurarMenu);

    </script>
</body>
</html>
